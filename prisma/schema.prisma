generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////

enum UserRole {
  FARMER
  LANDOWNER
  ADMIN
}

enum FarmingType {
  SUBSISTENCE
  COMMERCIAL
  ORGANIC
  MIXED
}

enum LandType {
  AGRICULTURAL
  FALLOW
  ORCHARD
  PASTURE
}

enum ListingStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  REJECTED
  CLOSED
  CANCELLED
  EXPIRED
}

enum ListingType {
  OPEN_BIDDING
  FIXED_PRICE
  SEALED_BID
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
  AUTO_REJECTED
}

enum LeaseStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

enum NotificationType {
  SYSTEM
  LEASE
  PAYMENT
  MESSAGE
  LISTING
  BID
}

//////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////

model User {
  id           String   @id @default(cuid())
  clerkUserId  String   @unique
  email        String   @unique
  name         String
  imageUrl     String?

  role         UserRole?
  isOnboarded  Boolean  @default(false)
  onboardingStep Int    @default(0)

  phone        String?
  state        String?
  district     String?
  bio          String?

  farmerProfile    FarmerProfile?
  landownerProfile LandownerProfile?

  applications Application[]

  leasesAsFarmer Lease[] @relation("FarmerLeases")
  leasesAsOwner  Lease[] @relation("OwnerLeases")

  listingsOwned LandListing[]

  messagesSent     Message[] @relation("MessagesSent")
  messagesReceived Message[] @relation("MessagesReceived")

  notifications Notification[]
  auditLogs AuditLog[]

  payments Payment[]
  subscription Subscription?

  documents Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// FARMER PROFILE
//////////////////////////////////////////////////

model FarmerProfile {
  id String @id @default(cuid())

  userId String @unique
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  primaryCrops String[]
  farmingExperience Int
  farmingType FarmingType

  requiredLandSize Float
  leaseDuration Int

  irrigationNeeded Boolean @default(false)
  equipmentAccess Boolean @default(false)

  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// LANDOWNER PROFILE
//////////////////////////////////////////////////

model LandownerProfile {
  id String @id @default(cuid())

  userId String @unique
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  lands Land[]

  ownershipType String?
  verificationLevel Int @default(0)

  preferredPaymentFrequency String?
  preferredContactMethod String?

  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// LAND
//////////////////////////////////////////////////

model Land {
  id String @id @default(cuid())

  landownerId String
  landowner LandownerProfile @relation(fields: [landownerId], references: [id], onDelete: Cascade)

  title String
  description String?

  size Float
  landType LandType

  soilType String?

  latitude Float?
  longitude Float?
  googleMapsUrl String?

  village String
  district String
  state String

  irrigationAvailable Boolean @default(false)
  waterSourceType String?

  electricityAvailable Boolean @default(false)
  roadAccess Boolean @default(false)
  fencingAvailable Boolean @default(false)
  storageAvailable Boolean @default(false)

  listings LandListing[]

  applications Application[]
  leases Lease[]

  documents Document[]
  soilReports SoilReport[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// LAND LISTING
//////////////////////////////////////////////////

model LandListing {
  id String @id @default(cuid())

  landId String
  land Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  ownerId String
  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  listingTitle String
  listingDescription String?

  listingHighlights String[]

  listingType ListingType @default(OPEN_BIDDING)

  basePrice Float
  reservePrice Float?
  buyNowPrice Float?

  bidIncrement Float?

  minimumLeaseDuration Int
  maximumLeaseDuration Int

  allowedCropTypes String[]

  startDate DateTime
  endDate DateTime

  autoExtendOnLastMinuteBid Boolean @default(true)
  autoExtendMinutes Int @default(10)

  status ListingStatus @default(DRAFT)

  submittedForApprovalAt DateTime?
  approvedAt DateTime?
  approvedBy String?

  autoApproved Boolean @default(false)

  rejectionReason String?

  totalBids Int @default(0)

  highestBid Float?
  highestBidderId String?

  winnerApplicationId String?

  isEditable Boolean @default(true)

  terms ListingTerms?

  applications Application[]
  leases Lease[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// LISTING TERMS
//////////////////////////////////////////////////

model ListingTerms {
  id String @id @default(cuid())

  listingId String @unique
  listing LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  securityDepositRequired Boolean @default(true)
  depositAmount Float?

  paymentFrequency String

  maintenanceResponsibility String

  electricityCostResponsibility String
  waterCostResponsibility String

  allowsSubleasing Boolean @default(false)
  allowsInfrastructureModification Boolean @default(false)

  earlyTerminationAllowed Boolean @default(false)
  terminationNoticePeriod Int?

  additionalTerms String?

  templateId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// APPLICATION
//////////////////////////////////////////////////

model Application {
  id String @id @default(cuid())

  listingId String
  listing LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  landId String
  land Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  farmerId String
  farmer User @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  proposedRent Float

  leaseDuration Int

  message String?

  acceptedTerms Boolean @default(false)
  acceptedTermsAt DateTime?

  status ApplicationStatus @default(PENDING)

  isWinningBid Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// LEASE
//////////////////////////////////////////////////

model Lease {
  id String @id @default(cuid())

  listingId String
  listing LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  landId String
  land Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  farmerId String
  farmer User @relation("FarmerLeases", fields: [farmerId], references: [id], onDelete: Cascade)

  ownerId String
  owner User @relation("OwnerLeases", fields: [ownerId], references: [id], onDelete: Cascade)

  rent Float
  securityDeposit Float?

  startDate DateTime
  endDate DateTime

  status LeaseStatus @default(DRAFT)

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// DOCUMENT
//////////////////////////////////////////////////

model Document {
  id String @id @default(cuid())

  landId String?
  userId String?

  land Land? @relation(fields: [landId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  name String
  url String

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////
// SOIL REPORT
//////////////////////////////////////////////////

model SoilReport {
  id String @id @default(cuid())

  landId String
  land Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  ph Float?
  moisture Float?
  nutrients String?

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////
// PAYMENT
//////////////////////////////////////////////////

model Payment {
  id String @id @default(cuid())

  userId String
  leaseId String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  lease Lease? @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  amount Float
  currency String @default("INR")

  status PaymentStatus @default(PENDING)

  providerRef String?

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////
// SUBSCRIPTION
//////////////////////////////////////////////////

model Subscription {
  id String @id @default(cuid())

  userId String @unique
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan String

  status SubscriptionStatus @default(ACTIVE)

  providerRef String?

  startedAt DateTime @default(now())
  endsAt DateTime?
}

//////////////////////////////////////////////////
// MESSAGE
//////////////////////////////////////////////////

model Message {
  id String @id @default(cuid())

  senderId String
  receiverId String

  sender User @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("MessagesReceived", fields: [receiverId], references: [id], onDelete: Cascade)

  content String

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////
// NOTIFICATION
//////////////////////////////////////////////////

model Notification {
  id String @id @default(cuid())

  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  type NotificationType

  title String
  message String

  isRead Boolean @default(false)

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////
// AUDIT LOG
//////////////////////////////////////////////////

model AuditLog {
  id String @id @default(cuid())

  userId String?
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  action String
  metadata Json?

  createdAt DateTime @default(now())
}
