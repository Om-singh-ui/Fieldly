
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////

enum UserRole {
  FARMER
  LANDOWNER
  ADMIN
}

enum FarmingType {
  SUBSISTENCE
  COMMERCIAL
  ORGANIC
  MIXED
}

enum LandType {
  AGRICULTURAL
  FALLOW
  ORCHARD
  PASTURE
}

enum ListingStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  REJECTED
  CLOSED
  CANCELLED
  EXPIRED
}

enum ListingType {
  OPEN_BIDDING
  FIXED_PRICE
  SEALED_BID
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
  AUTO_REJECTED
}

enum LeaseStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

enum NotificationType {
  SYSTEM
  LEASE
  PAYMENT
  MESSAGE
  LISTING
  BID
}

enum BidStatus {
  ACTIVE
  WITHDRAWN
  OUTBID
  WINNING
  ACCEPTED
}

enum CropType {
  CEREAL
  PULSE
  OILSEED
  VEGETABLE
  FRUIT
  FLOWER
  FODDER
  PLANTATION
  SPICE
  MEDICINAL
  OTHER
}

enum SoilType {
  ALLUVIAL
  BLACK
  RED
  LATERITE
  MOUNTAIN
  DESERT
  SALINE
  PEATY
  OTHER
}

enum WaterSource {
  BORE_WELL
  OPEN_WELL
  CANAL
  RIVER
  POND
  RAINWATER
  MUNICIPAL
  OTHER
}

enum PaymentFrequency {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  ONE_TIME
}

enum ListingEventType {
  CREATED
  PUBLISHED
  EDITED
  BID_PLACED
  ENDED
  SOLD
}

//////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////

model User {
  id              String   @id @default(cuid())
  clerkUserId     String   @unique
  email           String   @unique
  name            String
  imageUrl        String?

  role            UserRole?
  isOnboarded     Boolean  @default(false)
  onboardingStep  Int      @default(0)

  phone           String?
  address         String?
  pincode         String?
  state           String?
  district        String?
  bio             String?

  emailVerified   Boolean  @default(false)
  phoneVerified   Boolean  @default(false)
  lastLoginAt     DateTime?

  // Relations
  farmerProfile       FarmerProfile?
  landownerProfile    LandownerProfile?
  applications        Application[]
  leasesAsFarmer      Lease[] @relation("FarmerLeases")
  leasesAsOwner       Lease[] @relation("OwnerLeases")
  listingsOwned       LandListing[]
  bids                Bid[]
  savedListings       SavedListing[]
  listingViews        ListingView[]
  messagesSent        Message[] @relation("MessagesSent")
  messagesReceived    Message[] @relation("MessagesReceived")
  reviewsGiven        Review[] @relation("Reviewer")
  reviewsReceived     Review[] @relation("Reviewee")
  notifications       Notification[]
  auditLogs           AuditLog[]
  payments            Payment[]
  subscription        Subscription?
  documents           Document[] // Fixed: Added opposite relation for Document

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([createdAt])
  @@map("users")
}

//////////////////////////////////////////////////
// FARMER PROFILE
//////////////////////////////////////////////////

model FarmerProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  primaryCrops      CropType[]
  farmingExperience Int
  farmingType       FarmingType

  requiredLandSize  Float
  leaseDuration     Int

  irrigationNeeded  Boolean @default(false)
  equipmentAccess   Boolean @default(false)

  isVerified        Boolean @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("farmer_profiles")
}

//////////////////////////////////////////////////
// LANDOWNER PROFILE
//////////////////////////////////////////////////

model LandownerProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  lands     Land[]

  ownershipType String?
  verificationLevel Int @default(0)

  preferredPaymentFrequency PaymentFrequency?
  preferredContactMethod String?

  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("landowner_profiles")
}

//////////////////////////////////////////////////
// LAND
//////////////////////////////////////////////////

model Land {
  id                    String   @id @default(cuid())
  landownerId           String
  landowner             LandownerProfile @relation(fields: [landownerId], references: [id], onDelete: Cascade)

  title                 String
  description           String?

  size                  Float
  landType              LandType
  soilType              SoilType?

  latitude              Float?
  longitude             Float?
  googleMapsUrl         String?

  village               String
  district              String
  state                 String

  irrigationAvailable   Boolean @default(false)
  waterSourceType       WaterSource?
  electricityAvailable  Boolean @default(false)
  roadAccess            Boolean @default(false)
  fencingAvailable      Boolean @default(false)
  storageAvailable      Boolean @default(false)

  listings              LandListing[]
  applications          Application[]
  leases                Lease[]
  documents             Document[]
  soilReports           SoilReport[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([state, district])
  @@map("lands")
}

//////////////////////////////////////////////////
// LAND LISTING
//////////////////////////////////////////////////

model LandListing {
  id                    String   @id @default(cuid())

  landId                String
  land                  Land     @relation(fields: [landId], references: [id], onDelete: Cascade)

  ownerId               String
  owner                 User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  listingTitle          String
  listingDescription    String?
  listingHighlights     String[]

  listingType           ListingType @default(OPEN_BIDDING)

  basePrice             Float
  reservePrice          Float?
  buyNowPrice           Float?
  bidIncrement          Float?

  minimumLeaseDuration  Int
  maximumLeaseDuration  Int

  allowedCropTypes      CropType[]

  startDate             DateTime
  endDate               DateTime

  autoExtendOnLastMinuteBid Boolean @default(true)
  autoExtendMinutes     Int @default(10)

  status                ListingStatus @default(DRAFT)

  totalBids             Int     @default(0)
  highestBid            Float?
  highestBidderId       String?

  totalViews            Int     @default(0)
  watchlistCount        Int     @default(0)

  isEditable            Boolean @default(true)

  images                ListingImage[]
  bids                  Bid[]
  savedBy               SavedListing[]
  views                 ListingView[]
  applications          Application[]
  leases                Lease[]
  events                ListingEvent[]
  terms                 ListingTerms?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([status])
  @@index([ownerId])
  @@index([createdAt])
  @@map("land_listings")
}

//////////////////////////////////////////////////
// LISTING TERMS
//////////////////////////////////////////////////

model ListingTerms {
  id String @id @default(cuid())

  listingId String @unique
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  securityDepositRequired Boolean @default(true)
  depositAmount Float?

  paymentFrequency PaymentFrequency
  maintenanceResponsibility String
  electricityCostResponsibility String
  waterCostResponsibility String

  allowsSubleasing Boolean @default(false)
  allowsInfrastructureModification Boolean @default(false)

  earlyTerminationAllowed Boolean @default(false)
  terminationNoticePeriod Int?

  additionalTerms String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("listing_terms")
}

//////////////////////////////////////////////////
// BID
//////////////////////////////////////////////////

model Bid {
  id        String   @id @default(cuid())

  listingId String
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  farmerId  String
  farmer    User @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  amount      Float
  status      BidStatus @default(ACTIVE)
  isAutoBid   Boolean @default(false)
  maxAutoBid  Float?

  // Fixed: Added relation to Application
  application Application?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([listingId, amount])
  @@index([farmerId])
  @@map("bids")
}

//////////////////////////////////////////////////
// APPLICATION
//////////////////////////////////////////////////

model Application {
  id        String   @id @default(cuid())

  listingId String
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  landId    String
  land      Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  farmerId  String
  farmer    User @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  proposedRent Float
  leaseDuration Int

  proposedStartDate DateTime?
  cropPlan        String?
  investmentPlan  String?
  message         String?

  status ApplicationStatus @default(PENDING)

  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?

  // Fixed: Added proper relation to Bid
  bidId String? @unique
  bid   Bid?    @relation(fields: [bidId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([listingId])
  @@index([farmerId])
  @@map("applications")
}

//////////////////////////////////////////////////
// LEASE
//////////////////////////////////////////////////

model Lease {
  id        String   @id @default(cuid())

  listingId String
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  landId    String
  land      Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  farmerId  String
  farmer    User @relation("FarmerLeases", fields: [farmerId], references: [id], onDelete: Cascade)

  ownerId   String
  owner     User @relation("OwnerLeases", fields: [ownerId], references: [id], onDelete: Cascade)

  rent            Float
  securityDeposit Float?

  startDate DateTime
  endDate   DateTime

  status LeaseStatus @default(DRAFT)

  payments Payment[]
  review   Review?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmerId])
  @@index([ownerId])
  @@map("leases")
}

//////////////////////////////////////////////////
// LISTING IMAGE
//////////////////////////////////////////////////

model ListingImage {
  id        String   @id @default(cuid())
  listingId String
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  url       String
  caption   String?
  isPrimary Boolean @default(false)
  order     Int @default(0)

  @@unique([listingId, order])
  @@map("listing_images")
}

//////////////////////////////////////////////////
// SAVED LISTING
//////////////////////////////////////////////////

model SavedListing {
  id        String   @id @default(cuid())
  listingId String
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([listingId, userId])
  @@map("saved_listings")
}

//////////////////////////////////////////////////
// LISTING VIEW
//////////////////////////////////////////////////

model ListingView {
  id        String   @id @default(cuid())
  listingId String
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  viewerId  String
  viewer    User @relation(fields: [viewerId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now())

  @@map("listing_views")
}

//////////////////////////////////////////////////
// LISTING EVENT
//////////////////////////////////////////////////

model ListingEvent {
  id        String   @id @default(cuid())
  listingId String
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  userId    String?
  type      ListingEventType
  data      Json?
  createdAt DateTime @default(now())

  @@map("listing_events")
}

//////////////////////////////////////////////////
// REVIEW
//////////////////////////////////////////////////

model Review {
  id           String   @id @default(cuid())
  leaseId      String   @unique
  lease        Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  reviewerId   String
  reviewer     User     @relation("Reviewer", fields: [reviewerId], references: [id])
  revieweeId   String
  reviewee     User     @relation("Reviewee", fields: [revieweeId], references: [id])
  rating       Int
  comment      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("reviews")
}

//////////////////////////////////////////////////
// PAYMENT
//////////////////////////////////////////////////

model Payment {
  id      String @id @default(cuid())
  userId  String
  user    User @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaseId String?
  lease   Lease? @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  amount   Float
  currency String @default("INR")
  status PaymentStatus @default(PENDING)
  providerRef String?
  createdAt DateTime @default(now())

  @@map("payments")
}

//////////////////////////////////////////////////
// SUBSCRIPTION
//////////////////////////////////////////////////

model Subscription {
  id      String @id @default(cuid())
  userId  String @unique
  user    User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan   String
  status SubscriptionStatus @default(ACTIVE)
  providerRef String?
  startedAt DateTime @default(now())
  endsAt    DateTime?

  @@map("subscriptions")
}

//////////////////////////////////////////////////
// MESSAGE
//////////////////////////////////////////////////

model Message {
  id String @id @default(cuid())
  senderId   String
  receiverId String
  sender   User @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("MessagesReceived", fields: [receiverId], references: [id], onDelete: Cascade)
  content String
  createdAt DateTime @default(now())

  @@map("messages")
}

//////////////////////////////////////////////////
// NOTIFICATION
//////////////////////////////////////////////////

model Notification {
  id String @id @default(cuid())
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  type NotificationType
  title   String
  message String
  isRead Boolean @default(false)
  createdAt DateTime @default(now())

  @@map("notifications")
}

//////////////////////////////////////////////////
// AUDIT LOG
//////////////////////////////////////////////////

model AuditLog {
  id String @id @default(cuid())
  userId String?
  user   User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  action   String
  metadata Json?
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

//////////////////////////////////////////////////
// DOCUMENT
//////////////////////////////////////////////////

model Document {
  id String @id @default(cuid())
  landId String?
  userId String?
  land Land? @relation(fields: [landId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade) // Fixed: Now has opposite relation in User model
  name String
  url  String
  createdAt DateTime @default(now())

  @@map("documents")
}

//////////////////////////////////////////////////
// SOIL REPORT
//////////////////////////////////////////////////

model SoilReport {
  id String @id @default(cuid())
  landId String
  land Land @relation(fields: [landId], references: [id], onDelete: Cascade)
  ph Float?
  moisture Float?
  nutrients String?
  createdAt DateTime @default(now())

  @@map("soil_reports")
}