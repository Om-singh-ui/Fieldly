generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////

enum UserRole {
  FARMER
  LANDOWNER
  ADMIN
}

enum FarmingType {
  SUBSISTENCE
  COMMERCIAL
  ORGANIC
  MIXED
}

enum LandType {
  AGRICULTURAL
  FALLOW
  ORCHARD
  PASTURE
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  WITHDRAWN
}

enum LeaseStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

enum NotificationType {
  SYSTEM
  LEASE
  PAYMENT
  MESSAGE
  LISTING
  BID
  REVIEW
}

//////////////////////////////////////////////////
// MARKETPLACE ENUMS
//////////////////////////////////////////////////

enum ListingStatus {
  DRAFT
  ACTIVE
  CLOSED
  CANCELLED
  EXPIRED
}

enum ListingType {
  OPEN_BIDDING
  FIXED_PRICE
}

enum BidStatus {
  ACTIVE
  OUTBID
  WITHDRAWN
  ACCEPTED
}

enum PaymentFrequency {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  ONE_TIME
}

//////////////////////////////////////////////////
// USER (UNCHANGED CORE STRUCTURE)
//////////////////////////////////////////////////

model User {
  id           String  @id @default(cuid())
  clerkUserId  String  @unique
  email        String  @unique
  name         String
  imageUrl     String?

  role           UserRole?
  isOnboarded    Boolean @default(false)
  onboardingStep Int     @default(0)

  phone    String?
  state    String?
  district String?
  bio      String?

  farmerProfile    FarmerProfile?
  landownerProfile LandownerProfile?

  applications   Application[]
  leasesAsFarmer Lease[] @relation("FarmerLeases")
  leasesAsOwner  Lease[] @relation("OwnerLeases")

  messagesSent     Message[] @relation("MessagesSent")
  messagesReceived Message[] @relation("MessagesReceived")

  notifications Notification[]
  auditLogs     AuditLog[]
  payments      Payment[]
  subscription  Subscription?
  documents     Document[]

  // Marketplace Additions (SAFE)
  listingsOwned LandListing[]
  bids          Bid[]
  savedListings SavedListing[]
  reviewsGiven  Review[] @relation("Reviewer")
  reviewsReceived Review[] @relation("Reviewee")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// FARMER PROFILE (UNCHANGED)
//////////////////////////////////////////////////

model FarmerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  primaryCrops      String[]
  farmingExperience Int
  farmingType       FarmingType

  requiredLandSize Float
  leaseDuration    Int
  irrigationNeeded Boolean @default(false)
  equipmentAccess  Boolean @default(false)

  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// LANDOWNER PROFILE (UNCHANGED)
//////////////////////////////////////////////////

model LandownerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  lands Land[]

  ownershipType String?
  verificationLevel Int @default(0)

  preferredPaymentFrequency String?
  preferredContactMethod String?

  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// LAND (UNCHANGED + LISTINGS ADDED)
//////////////////////////////////////////////////

model Land {
  id          String           @id @default(cuid())
  landownerId String
  landowner   LandownerProfile @relation(fields: [landownerId], references: [id], onDelete: Cascade)

  title        String
  size         Float
  landType     LandType
  soilType     String?
  irrigationAvailable Boolean @default(false)

  latitude  Float?
  longitude Float?
  village   String?

  electricityAvailable Boolean?
  roadAccess Boolean?
  storageAvailable Boolean?
  fencingAvailable Boolean?
  waterSourceType String?

  allowsSubleasing Boolean @default(false)
  securityDepositRequired Boolean @default(true)
  depositAmount Float?

  preferredFarmerExperienceMin Int?
  allowsOrganicFarming Boolean @default(true)
  allowsInfrastructureModification Boolean @default(false)

  minLeaseDuration Int
  maxLeaseDuration Int
  expectedRentMin Float?
  expectedRentMax Float?
  allowedCropTypes String[]

  applications Application[]
  leases Lease[]
  soilReports SoilReport[]
  documents Document[]

  listings LandListing[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// LAND LISTING (ENHANCED BUT SAFE)
//////////////////////////////////////////////////

model LandListing {
  id        String @id @default(cuid())

  landId    String
  land      Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  ownerId   String
  owner     User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  title       String
  description String?

  listingType ListingType @default(OPEN_BIDDING)
  status      ListingStatus @default(DRAFT)

  basePrice   Float
  reservePrice Float?
  buyNowPrice Float?

  minimumLeaseDuration Int
  maximumLeaseDuration Int

  startDate DateTime
  endDate   DateTime

  totalBids  Int @default(0)
  highestBid Float?

  bids        Bid[]
  savedBy     SavedListing[]
  applications Application[]
  leases       Lease[]
  images       ListingImage[]
  terms        ListingTerms?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([ownerId])
}

//////////////////////////////////////////////////
// LISTING TERMS (Legal Layer)
//////////////////////////////////////////////////

model ListingTerms {
  id String @id @default(cuid())

  listingId String @unique
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  securityDepositRequired Boolean @default(true)
  depositAmount Float?

  paymentFrequency PaymentFrequency

  maintenanceResponsibility String?
  electricityCostResponsibility String?
  waterCostResponsibility String?

  allowsSubleasing Boolean @default(false)
  allowsInfrastructureModification Boolean @default(false)

  additionalTerms String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// BID
//////////////////////////////////////////////////

model Bid {
  id        String @id @default(cuid())

  listingId String
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  farmerId  String
  farmer    User @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  amount Float
  status BidStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([listingId, amount])
}

//////////////////////////////////////////////////
// APPLICATION (BACKWARD SAFE + MARKETPLACE READY)
//////////////////////////////////////////////////

model Application {
  id       String @id @default(cuid())

  landId   String
  land     Land   @relation(fields: [landId], references: [id], onDelete: Cascade)

  farmerId String
  farmer   User   @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  listingId String?
  listing   LandListing? @relation(fields: [listingId], references: [id])

  proposedRent Float?
  duration     Int
  cropPlan     String?
  message      String?

  status ApplicationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// LEASE
//////////////////////////////////////////////////

model Lease {
  id       String @id @default(cuid())

  landId   String
  land     Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  farmerId String
  farmer   User @relation("FarmerLeases", fields: [farmerId], references: [id], onDelete: Cascade)

  ownerId  String
  owner    User @relation("OwnerLeases", fields: [ownerId], references: [id], onDelete: Cascade)

  listingId String?
  listing   LandListing? @relation(fields: [listingId], references: [id])

  rent            Float
  securityDeposit Float?

  startDate DateTime
  endDate   DateTime
  status    LeaseStatus @default(DRAFT)

  payments Payment[]
  review   Review?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// REVIEW (TRUST LAYER)
//////////////////////////////////////////////////

model Review {
  id        String @id @default(cuid())

  leaseId   String @unique
  lease     Lease  @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  reviewerId String
  reviewer   User @relation("Reviewer", fields: [reviewerId], references: [id])

  revieweeId String
  reviewee   User @relation("Reviewee", fields: [revieweeId], references: [id])

  rating  Int
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// LISTING IMAGE
//////////////////////////////////////////////////

model ListingImage {
  id        String @id @default(cuid())
  listingId String
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  url       String
  caption   String?
  isPrimary Boolean @default(false)
}

//////////////////////////////////////////////////
// SAVED LISTING
//////////////////////////////////////////////////

model SavedListing {
  id        String @id @default(cuid())
  listingId String
  listing   LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([listingId, userId])
}

//////////////////////////////////////////////////
// REMAINING MODELS (UNCHANGED CORE)
//////////////////////////////////////////////////

model Payment {
  id      String @id @default(cuid())
  userId  String
  leaseId String?

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lease Lease? @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  amount      Float
  currency    String @default("INR")
  status      PaymentStatus @default(PENDING)
  providerRef String?

  createdAt DateTime @default(now())
}

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan   String
  status SubscriptionStatus @default(ACTIVE)

  startedAt DateTime @default(now())
  endsAt    DateTime?
}

model Message {
  id         String @id @default(cuid())
  senderId   String
  receiverId String

  sender   User @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("MessagesReceived", fields: [receiverId], references: [id], onDelete: Cascade)

  content   String
  createdAt DateTime @default(now())
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String
  isRead  Boolean @default(false)

  createdAt DateTime @default(now())
}

model AuditLog {
  id     String @id @default(cuid())
  userId String?
  user   User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  action   String
  metadata Json?

  createdAt DateTime @default(now())
}

model Document {
  id     String @id @default(cuid())
  landId String?
  userId String?

  land Land? @relation(fields: [landId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  name String
  url  String

  createdAt DateTime @default(now())
}

model SoilReport {
  id     String @id @default(cuid())
  landId String
  land   Land   @relation(fields: [landId], references: [id], onDelete: Cascade)

  ph        Float?
  moisture  Float?
  nutrients String?

  createdAt DateTime @default(now())
}