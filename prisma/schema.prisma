generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String           @id @default(cuid())
  clerkUserId      String           @unique
  email            String           @unique
  name             String
  imageUrl         String?
  role             UserRole?
  isOnboarded      Boolean          @default(false)
  onboardingStep   Int              @default(0)
  phone            String?
  state            String?
  district         String?
  bio              String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  farmerProfile    FarmerProfile?
  landownerProfile LandownerProfile?
  subscription     Subscription?

  listingsOwned    LandListing[]
  applications     Application[]
  bids             Bid[]
  documents        Document[]
  auditLogs        AuditLog[]

  leasesAsFarmer   Lease[] @relation("FarmerLeases")
  leasesAsOwner    Lease[] @relation("OwnerLeases")

  messagesSent     Message[] @relation("MessagesSent")
  messagesReceived Message[] @relation("MessagesReceived")

  notifications    Notification[]
  payments         Payment[]

  reviewsGiven     Review[] @relation("Reviewer")
  reviewsReceived  Review[] @relation("Reviewee")

  savedListings    SavedListing[]

  @@index([clerkUserId])
}

model FarmerProfile {
  id                String      @id @default(cuid())
  userId            String      @unique
  primaryCrops      String[]
  farmingExperience Int
  farmingType       FarmingType
  requiredLandSize  Float
  leaseDuration     Int
  irrigationNeeded  Boolean     @default(false)
  equipmentAccess   Boolean     @default(false)
  isVerified        Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LandownerProfile {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  ownershipType             String?
  verificationLevel         Int      @default(0)
  preferredPaymentFrequency String?
  preferredContactMethod    String?
  isVerified                Boolean  @default(false)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lands Land[]
}

model Land {
  id             String @id @default(cuid())
  landownerId    String
  title          String
  size           Float
  landType       LandType

  soilType       String?
  latitude       Float?
  longitude      Float?
  village        String?

  irrigationAvailable Boolean @default(false)
  electricityAvailable Boolean?
  roadAccess Boolean?
  fencingAvailable Boolean?
  storageAvailable Boolean?

  allowedCropTypes String[]

  allowsInfrastructureModification Boolean @default(false)
  allowsOrganicFarming Boolean @default(true)
  allowsSubleasing Boolean @default(false)

  depositAmount Float?
  expectedRentMin Float?
  expectedRentMax Float?

  minLeaseDuration Int
  maxLeaseDuration Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  landowner LandownerProfile @relation(fields: [landownerId], references: [id], onDelete: Cascade)

  listings LandListing[]
  applications Application[]
  leases Lease[]
  documents Document[]
  soilReports SoilReport[]

  @@index([landownerId])
}

model LandListing {
  id String @id @default(cuid())

  landId String
  ownerId String

  title String
  description String?

  listingType ListingType @default(OPEN_BIDDING)
  status ListingStatus @default(DRAFT)

  basePrice Float
  reservePrice Float?
  buyNowPrice Float?

  minimumLeaseDuration Int
  maximumLeaseDuration Int

  startDate DateTime
  endDate DateTime

  totalBids Int @default(0)
  highestBid Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  land Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  bids Bid[]
  applications Application[]
  leases Lease[]

  images ListingImage[]
  terms ListingTerms?
  savedBy SavedListing[]

  @@index([ownerId])
  @@index([status])
}

model ListingTerms {
  id String @id @default(cuid())

  listingId String @unique

  securityDepositRequired Boolean @default(true)
  depositAmount Float?

  paymentFrequency PaymentFrequency

  additionalTerms String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listing LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model Bid {
  id String @id @default(cuid())

  listingId String
  farmerId String

  amount Float
  status BidStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listing LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  farmer User @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([farmerId])
}

model Application {
  id String @id @default(cuid())

  landId String
  farmerId String
  listingId String?

  proposedRent Float?
  duration Int

  message String?
  cropPlan String?

  status ApplicationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  farmer User @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  land Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  listing LandListing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([farmerId])
}

model Lease {
  id String @id @default(cuid())

  landId String
  farmerId String
  ownerId String
  listingId String?

  rent Float
  securityDeposit Float?

  startDate DateTime
  endDate DateTime

  status LeaseStatus @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  land Land @relation(fields: [landId], references: [id], onDelete: Cascade)

  listing LandListing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

  farmer User @relation("FarmerLeases", fields: [farmerId], references: [id], onDelete: Cascade)

  owner User @relation("OwnerLeases", fields: [ownerId], references: [id], onDelete: Cascade)

  payments Payment[]
  review Review?

  @@index([farmerId])
  @@index([ownerId])
}

model Payment {
  id String @id @default(cuid())

  userId String
  leaseId String?

  amount Float
  currency String @default("INR")

  status PaymentStatus @default(PENDING)

  providerRef String?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  lease Lease? @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscription {
  id String @id @default(cuid())

  userId String @unique

  plan String

  status SubscriptionStatus @default(ACTIVE)

  startedAt DateTime @default(now())
  endsAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Review {
  id String @id @default(cuid())

  leaseId String @unique

  reviewerId String
  revieweeId String

  rating Int
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lease Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  reviewer User @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)

  reviewee User @relation("Reviewee", fields: [revieweeId], references: [id], onDelete: Cascade)
}

model Message {
  id String @id @default(cuid())

  senderId String
  receiverId String

  content String

  createdAt DateTime @default(now())

  sender User @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)

  receiver User @relation("MessagesReceived", fields: [receiverId], references: [id], onDelete: Cascade)
}

model Notification {
  id String @id @default(cuid())

  userId String

  type NotificationType

  title String
  message String

  isRead Boolean @default(false)

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SavedListing {
  id String @id @default(cuid())

  listingId String
  userId String

  listing LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([listingId, userId])
}

model ListingImage {
  id String @id @default(cuid())

  listingId String

  url String
  caption String?

  isPrimary Boolean @default(false)

  listing LandListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model SoilReport {
  id String @id @default(cuid())

  landId String

  ph Float?
  moisture Float?

  nutrients String?

  createdAt DateTime @default(now())

  land Land @relation(fields: [landId], references: [id], onDelete: Cascade)
}

model Document {
  id String @id @default(cuid())

  userId String?
  landId String?

  name String
  url String

  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  land Land? @relation(fields: [landId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id String @id @default(cuid())

  userId String?

  action String

  metadata Json?

  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum UserRole {
  FARMER
  LANDOWNER
  ADMIN
}

enum FarmingType {
  SUBSISTENCE
  COMMERCIAL
  ORGANIC
  MIXED
}

enum LandType {
  AGRICULTURAL
  FALLOW
  ORCHARD
  PASTURE
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  WITHDRAWN
}

enum LeaseStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

enum NotificationType {
  SYSTEM
  LEASE
  PAYMENT
  MESSAGE
  LISTING
  BID
  REVIEW
}

enum ListingStatus {
  DRAFT
  ACTIVE
  CLOSED
  CANCELLED
  EXPIRED
}

enum ListingType {
  OPEN_BIDDING
  FIXED_PRICE
}

enum BidStatus {
  ACTIVE
  OUTBID
  WITHDRAWN
  ACCEPTED
}

enum PaymentFrequency {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  ONE_TIME
}